<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // High contrast colors for readability
                        'port-bg': '#1a1a2e',
                        'card-bg': '#16213e',
                        'card-border': '#0f3460',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            background: #0a0a0f;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Fixed card sizing for 1024x600 display */
        .port-card {
            height: 250px;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #0f3460;
            transition: border-color 0.2s ease;
        }

        .port-card.state-success { border-color: #22c55e; }
        .port-card.state-warning { border-color: #f59e0b; }
        .port-card.state-error { border-color: #ef4444; }
        .port-card.state-active { border-color: #3b82f6; animation: pulse-glow 2s infinite; }
        .port-card.state-idle { border-color: #374151; }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 15px 2px rgba(59, 130, 246, 0.3); }
        }

        /* Status icons */
        .status-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .status-icon.pending { background: #374151; color: #6b7280; }
        .status-icon.success { background: #166534; color: #4ade80; }
        .status-icon.error { background: #7f1d1d; color: #fca5a5; }
        .status-icon.active { background: #1e40af; color: #93c5fd; animation: icon-pulse 1.5s infinite; }
        .status-icon.loading { background: #854d0e; color: #fbbf24; animation: icon-pulse 1.5s infinite; }
        .status-icon.skipped { background: #374151; color: #9ca3af; }

        @keyframes icon-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Speed badge */
        .speed-badge {
            background: #1e40af;
            color: #93c5fd;
            font-weight: 700;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 4px;
        }

        /* Device info section */
        .device-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px 10px;
        }

        /* Status bar at bottom of card */
        .status-bar {
            font-size: 13px;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 4px;
            text-align: center;
        }

        .status-bar.idle { background: #1f2937; color: #6b7280; }
        .status-bar.booting { background: #78350f; color: #fcd34d; }
        .status-bar.ready { background: #14532d; color: #86efac; }
        .status-bar.active { background: #1e3a8a; color: #93c5fd; }
        .status-bar.complete { background: #166534; color: #4ade80; }
        .status-bar.error { background: #7f1d1d; color: #fca5a5; }

        /* No link state - dim the card */
        .port-card.no-link {
            opacity: 0.5;
        }

        /* Header buttons */
        .header-btn {
            min-height: 40px;
            min-width: 40px;
            background: #1f2937;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover { background: #374151; }

        /* Modal styles */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        /* Sleep overlay */
        #sleep-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: none;
            cursor: pointer;
        }
        #sleep-overlay.active {
            display: block;
        }
    </style>
</head>
<body class="dark text-white min-h-screen flex flex-col overflow-hidden">
    <!-- Sleep Overlay - full screen black, click/touch to wake -->
    <div id="sleep-overlay" onclick="wakeDisplay()"></div>

    <!-- Compact Header -->
    <header class="bg-[#0f0f1a] border-b border-[#1f2937] px-4 py-2 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-green-500" id="connection-indicator"></div>
            <h1 class="text-lg font-bold text-white">Device Provisioner</h1>
            <span class="text-xs text-gray-500 font-mono" id="management-url"></span>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-400 mr-2" id="status-text">Connecting...</span>
            <a href="/files" class="header-btn p-2" title="Firmware & Configs">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                </svg>
            </a>
            <button onclick="openHistoryModal()" class="header-btn p-2" title="History">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button onclick="openSettings()" class="header-btn p-2" title="Settings">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content - 2x4 Port Grid -->
    <main class="flex-1 p-3 flex items-center justify-center">
        <div class="w-full max-w-[1000px]">
            <!-- Top row: ports 2, 4, 6 (even) -->
            <div class="grid grid-cols-3 gap-3 mb-3" id="port-row-top"></div>
            <!-- Bottom row: ports 1, 3, 5 (odd) -->
            <div class="grid grid-cols-3 gap-3" id="port-row-bottom"></div>
        </div>
    </main>

    <!-- Port Action Modal -->
    <div id="port-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/60" onclick="closeModal()"></div>
        <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-md bg-[#16213e] rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[80vh] border border-[#0f3460]">
            <div class="px-5 py-3 border-b border-[#0f3460] flex items-center justify-between">
                <h3 class="text-lg font-bold" id="modal-title">Port Actions</h3>
                <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-[#1a1a2e]">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5" id="modal-content"></div>
            <div class="px-5 py-3 border-t border-[#0f3460] flex gap-2" id="modal-footer"></div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/60" onclick="closeHistoryModal()"></div>
        <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-[#16213e] rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[80vh] border border-[#0f3460]">
            <div class="px-5 py-3 border-b border-[#0f3460] flex items-center justify-between">
                <h3 class="text-lg font-bold">Provisioning History</h3>
                <button onclick="closeHistoryModal()" class="p-2 rounded-lg hover:bg-[#1a1a2e]">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5" id="history-content">
                <div class="text-gray-400 text-center py-8">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/60" onclick="closeSettings()"></div>
        <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-md bg-[#16213e] rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[80vh] border border-[#0f3460]">
            <div class="px-5 py-3 border-b border-[#0f3460] flex items-center justify-between">
                <h3 class="text-lg font-bold">Settings</h3>
                <button onclick="closeSettings()" class="p-2 rounded-lg hover:bg-[#1a1a2e]">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">System Status</label>
                    <div class="bg-[#1a1a2e] rounded-lg p-3 text-sm" id="system-status">Loading...</div>
                </div>
                <div class="space-y-2">
                    <button onclick="triggerGitSync()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium text-sm">
                        Sync GitHub Repository
                    </button>
                    <button onclick="location.reload()" class="w-full py-2 bg-[#1a1a2e] hover:bg-[#252540] rounded-lg font-medium text-sm">
                        Refresh Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // State
        let ws = null;
        let ports = {};
        let selectedPort = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        // Display sleep state
        let displaySleeping = false;
        let idleTimeout = null;
        let displayConfig = {
            sleep_timeout: 300,
            wake_on_connect: true,
        };

        // Device vendors
        const deviceVendors = {
            cambium: { name: 'Cambium', color: '#22c55e', defaultUser: 'admin' },
            mikrotik: { name: 'MikroTik', color: '#3b82f6', defaultUser: 'admin' },
            tachyon: { name: 'Tachyon', color: '#a855f7', defaultUser: 'root' },
            tarana: { name: 'Tarana', color: '#f59e0b', defaultUser: 'admin' },
            unknown: { name: 'Unknown', color: '#6b7280', defaultUser: 'admin' },
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Display management URL in header
            document.getElementById('management-url').textContent = window.location.host;
            // Fetch display config (for sleep timeout)
            fetchDisplayConfig();
            connectWebSocket();
        });

        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/status`);

            ws.onopen = () => {
                document.getElementById('connection-indicator').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('status-text').textContent = 'Connected';
                reconnectAttempts = 0;
            };

            ws.onclose = () => {
                document.getElementById('connection-indicator').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('status-text').textContent = 'Disconnected';
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                }
            };

            ws.onerror = (error) => console.error('WebSocket error:', error);

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'initial_status':
                case 'status_update':
                    updatePorts(message.data.ports);
                    checkIdleState();
                    break;
                case 'port_update':
                    updateSinglePort(message.port_number, message.data);
                    checkIdleState();
                    break;
                case 'display_state':
                    handleDisplayStateMessage(message);
                    break;
                case 'provisioning_started':
                case 'provisioning_progress':
                case 'provisioning_completed':
                case 'credentials_required':
                    // Update port data and re-render
                    if (ports[message.port_number]) {
                        if (message.type === 'provisioning_started') {
                            ports[message.port_number].provisioning = true;
                            ports[message.port_number].current_step = 'starting';
                        } else if (message.type === 'provisioning_progress') {
                            // Track current step for status display
                            ports[message.port_number].current_step = message.step;
                        } else if (message.type === 'provisioning_completed') {
                            ports[message.port_number].provisioning = false;
                            ports[message.port_number].current_step = null;
                            ports[message.port_number].last_result = message.success ? 'complete' : 'failed';
                            ports[message.port_number].last_error = message.data?.error;
                            // Preserve needs_credentials flag from completion data
                            if (message.data?.needs_credentials) {
                                ports[message.port_number].needs_credentials = true;
                            }
                            showToast(
                                message.success ? `Port ${message.port_number}: Complete` : `Port ${message.port_number}: Failed`,
                                message.success ? 'success' : 'error'
                            );
                        } else if (message.type === 'credentials_required') {
                            ports[message.port_number].needs_credentials = true;
                            ports[message.port_number].last_error = message.error || 'Invalid credentials';
                            showToast(`Port ${message.port_number}: Tap to enter credentials`, 'warning');
                            // Don't auto-open modal - let user tap the port card
                        }
                        renderPorts();
                    }
                    break;
            }
        }

        function updatePorts(portsData) {
            ports = portsData;
            renderPorts();
        }

        function updateSinglePort(portNumber, data) {
            ports[portNumber] = { ...ports[portNumber], ...data };
            renderPorts();
        }

        function formatSpeed(speed) {
            if (!speed) return null;
            return speed.replace('bps', '').replace('Gbps', 'G').replace('Mbps', 'M');
        }

        function getCardState(port) {
            const checklist = port.checklist || {};

            if (!port.link_up) return 'idle';
            if (port.provisioning) return 'active';
            // Loading firmware updates
            if (checklist.firmware_update_1 === 'loading' || checklist.firmware_update_2 === 'loading') return 'active';
            // Complete when verify is done
            if (port.last_result === 'complete' || (checklist.login === true && checklist.verify === true)) return 'success';
            // Failed
            if (port.last_result === 'failed' || checklist.login === false || checklist.firmware_update_1 === false) return 'error';
            if (port.waiting_for_boot) return 'warning';
            if (port.device_detected) return 'success';
            return 'warning';
        }

        function getStatusBarInfo(port) {
            const checklist = port.checklist || {};

            if (!port.link_up) return { text: 'NO LINK', class: 'idle' };
            if (port.needs_credentials) return { text: 'NEEDS CREDENTIALS', class: 'error' };
            if (port.provisioning) {
                // Show step-specific status
                const stepLabels = {
                    'starting': 'STARTING...',
                    'detecting': 'DETECTING...',
                    'configuring': 'CONFIGURING...',
                    'login': 'LOGGING IN...',
                    'model_confirmed': 'DETECTED...',
                    'device_info': 'READING INFO...',
                    'firmware_banks': 'CHECKING FW...',
                    'firmware_update_1': 'UPDATING FW 1...',
                    'firmware_update_2': 'UPDATING FW 2...',
                    'config_upload': 'APPLYING CONFIG...',
                    'reboot': 'REBOOTING...',
                    'verify': 'VERIFYING...',
                };
                const stepText = stepLabels[port.current_step] || 'PROVISIONING...';
                return { text: stepText, class: 'active' };
            }
            if (port.waiting_for_boot) return { text: 'BOOTING...', class: 'booting' };

            // Check for loading states (firmware being updated)
            if (checklist.firmware_update_1 === 'loading' || checklist.firmware_update_2 === 'loading') {
                return { text: 'UPDATING...', class: 'active' };
            }
            if (checklist.reboot === true && checklist.verify !== true) {
                return { text: 'REBOOTING...', class: 'booting' };
            }

            // Check if complete - need login, config, and at least one firmware update confirmed
            const loginOk = checklist.login === true;
            const configOk = checklist.config_upload === true || checklist.config_upload === 'skipped';
            const fw1Ok = checklist.firmware_update_1 === true;
            const verifyOk = checklist.verify === true;

            if (loginOk && configOk && fw1Ok && verifyOk) return { text: 'COMPLETE', class: 'complete' };
            if (port.last_result === 'complete') return { text: 'COMPLETE', class: 'complete' };
            if (checklist.login === false || checklist.firmware_update_1 === false || port.last_result === 'failed') {
                return { text: 'FAILED', class: 'error' };
            }
            if (port.device_detected) return { text: 'READY', class: 'ready' };

            return { text: 'DETECTING...', class: 'booting' };
        }

        function getIconState(checklist, key) {
            const value = checklist[key];
            if (value === true) return 'success';
            if (value === false) return 'error';
            if (value === 'loading') return 'loading';
            if (value === 'skipped') return 'skipped';
            if (typeof value === 'string' && value.length > 0) return 'success'; // e.g., model_confirmed with name
            return 'pending';
        }

        function renderPorts() {
            const topRow = document.getElementById('port-row-top');
            const bottomRow = document.getElementById('port-row-bottom');
            topRow.innerHTML = '';
            bottomRow.innerHTML = '';

            const topPorts = [2, 4, 6];
            const bottomPorts = [1, 3, 5];

            for (const portNum of topPorts) {
                const port = ports[portNum] || { vlan_id: 1990 + portNum, link_up: false };
                topRow.appendChild(createPortCard(portNum, port));
            }

            for (const portNum of bottomPorts) {
                const port = ports[portNum] || { vlan_id: 1990 + portNum, link_up: false };
                bottomRow.appendChild(createPortCard(portNum, port));
            }
        }

        function createPortCard(portNum, port) {
            const div = document.createElement('div');
            const checklist = port.checklist || {};
            const cardState = getCardState(port);
            const statusBar = getStatusBarInfo(port);
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;
            const speed = formatSpeed(port.link_speed);
            const model = checklist.model_confirmed || port.device_model;
            const mac = checklist.mac_address || port.device_mac;

            // Determine icon states
            const loginState = getIconState(checklist, 'login');
            const configState = getIconState(checklist, 'config_upload');

            // Firmware states - based on firmware_update_1 and firmware_update_2
            let fw1State = 'pending', fw2State = 'pending';
            let fw1Ver = '', fw2Ver = '';

            // Parse firmware_banks for version display
            if (checklist.firmware_banks) {
                const parts = {};
                checklist.firmware_banks.split('|').forEach(p => {
                    const [k, v] = p.split(':');
                    if (k && v) parts[k] = v;
                });
                fw1Ver = parts.bank1 || '';
                fw2Ver = parts.bank2 || '';
            }

            // Firmware update 1 state (only green after confirmed)
            if (checklist.firmware_update_1 === true) {
                fw1State = 'success';
            } else if (checklist.firmware_update_1 === 'loading') {
                fw1State = 'loading';
            } else if (checklist.firmware_update_1 === false) {
                fw1State = 'error';
            }

            // Firmware update 2 state (only green after confirmed)
            if (checklist.firmware_update_2 === true) {
                fw2State = 'success';
            } else if (checklist.firmware_update_2 === 'loading') {
                fw2State = 'loading';
            } else if (checklist.firmware_update_2 === false) {
                fw2State = 'error';
            }

            const noLink = !port.link_up;

            div.className = `port-card rounded-xl p-3 flex flex-col state-${cardState} ${noLink ? 'no-link' : ''}`;
            // Allow clicking if device detected OR needs credentials
            const clickable = port.device_detected || port.needs_credentials;
            div.onclick = () => {
                if (port.needs_credentials) {
                    openCredentialModal(portNum);
                } else if (port.device_detected) {
                    openPortModal(portNum);
                }
            };
            div.style.cursor = clickable ? 'pointer' : 'default';

            div.innerHTML = `
                <!-- Header: Port number + Speed -->
                <div class="flex items-center justify-between mb-2">
                    <div class="text-3xl font-black text-white">${portNum}</div>
                    ${speed ? `<div class="speed-badge">${speed}</div>` : '<div class="text-gray-500 text-sm">—</div>'}
                </div>

                <!-- Status Icons Row: Login → FW1 → Config → FW2 -->
                <div class="flex justify-between mb-3">
                    <div class="status-icon ${loginState}" title="Login">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${loginState === 'success'
                                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>'
                                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>'
                            }
                        </svg>
                    </div>
                    <div class="status-icon ${fw1State}" title="Firmware Bank 1${fw1Ver ? ': ' + fw1Ver : ''}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                            <text x="12" y="17" text-anchor="middle" font-size="8" font-weight="bold" fill="currentColor" stroke="none">1</text>
                        </svg>
                    </div>
                    <div class="status-icon ${configState}" title="Config">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div class="status-icon ${fw2State}" title="Firmware Bank 2${fw2Ver ? ': ' + fw2Ver : ''}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                            <text x="12" y="17" text-anchor="middle" font-size="8" font-weight="bold" fill="currentColor" stroke="none">2</text>
                        </svg>
                    </div>
                </div>

                <!-- Device Info -->
                <div class="device-info flex-1 mb-2">
                    ${port.device_detected || checklist.login ? `
                        <div class="text-white text-sm truncate mb-1">
                            <span class="font-bold" style="color: ${vendor.color}">${vendor.name}</span>${model ? ` ${model}` : ''}
                        </div>
                        ${mac ? `<div class="text-blue-300 text-xs font-mono truncate">${mac}</div>` : ''}
                    ` : `
                        <div class="text-gray-500 text-sm">${noLink ? 'No device connected' : 'Waiting for device...'}</div>
                    `}
                </div>

                <!-- Status Bar -->
                <div class="status-bar ${statusBar.class}">${statusBar.text}</div>
            `;

            return div;
        }

        // Modal functions
        function openPortModal(portNum) {
            selectedPort = portNum;
            const port = ports[portNum];
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;
            const checklist = port.checklist || {};
            const mac = checklist.mac_address || port.device_mac;
            const serial = checklist.serial_number || port.device_serial;
            const model = checklist.model_confirmed || port.device_model;

            // Parse firmware versions from checklist
            let fw1Ver = '-', fw2Ver = '-', activeBank = '-';
            if (checklist.firmware_banks) {
                const parts = {};
                checklist.firmware_banks.split('|').forEach(p => {
                    const [k, v] = p.split(':');
                    if (k && v) parts[k] = v;
                });
                fw1Ver = parts.bank1 || '-';
                fw2Ver = parts.bank2 || '-';
                activeBank = parts.active || '-';
            }

            document.getElementById('modal-title').textContent = `Port ${portNum} - ${vendor.name}`;
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="text-gray-400">Model</div>
                        <div class="text-white font-medium">${model || '-'}</div>
                        <div class="text-gray-400">MAC Address</div>
                        <div class="text-blue-300 font-mono text-xs">${mac || '-'}</div>
                        <div class="text-gray-400">Serial</div>
                        <div class="text-purple-300 font-mono text-xs">${serial || '-'}</div>
                        <div class="text-gray-400">IP Address</div>
                        <div class="text-white">${port.device_ip || '-'}</div>
                        <div class="text-gray-400">Link Speed</div>
                        <div class="text-white">${port.link_speed || '-'}</div>
                        <div class="text-gray-400">Firmware Bank 1</div>
                        <div class="text-green-400 font-mono text-xs">${fw1Ver}${activeBank === '1' ? ' (active)' : ''}</div>
                        <div class="text-gray-400">Firmware Bank 2</div>
                        <div class="text-green-400 font-mono text-xs">${fw2Ver}${activeBank === '2' ? ' (active)' : ''}</div>
                    </div>

                    ${port.last_error ? `
                        <div class="p-3 bg-red-900/30 border border-red-800 rounded-lg text-red-300 text-sm">
                            ${port.last_error}
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('modal-footer').innerHTML = `
                <button onclick="openProvisionModal(${portNum})" class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium text-sm">
                    ${port.last_result === 'complete' ? 'Re-provision' : 'Provision'}
                </button>
                <button onclick="closeModal()" class="flex-1 py-2 bg-[#1a1a2e] hover:bg-[#252540] rounded-lg font-medium text-sm">
                    Close
                </button>
            `;
            document.getElementById('port-modal').classList.remove('hidden');
        }

        function openProvisionModal(portNum) {
            selectedPort = portNum;
            const port = ports[portNum];
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;

            document.getElementById('modal-title').textContent = `Provision Port ${portNum}`;
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="p-3 bg-[#1a1a2e] rounded-lg">
                        <div class="font-bold text-lg" style="color: ${vendor.color}">${vendor.name}</div>
                        <div class="text-sm text-gray-400">${port.device_ip || 'Unknown IP'}</div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-300 mb-2">Options</div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="skip-config" class="w-5 h-5 rounded bg-[#1a1a2e] border-gray-600">
                                <span class="text-sm text-white">Skip configuration</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="skip-firmware" class="w-5 h-5 rounded bg-[#1a1a2e] border-gray-600">
                                <span class="text-sm text-white">Skip firmware update</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-300 mb-2">Custom Credentials (optional)</div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="custom-username" placeholder="Username"
                                class="bg-[#1a1a2e] border border-gray-600 rounded-lg px-3 py-2 text-sm text-white">
                            <input type="password" id="custom-password" placeholder="Password"
                                class="bg-[#1a1a2e] border border-gray-600 rounded-lg px-3 py-2 text-sm text-white">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-footer').innerHTML = `
                <button onclick="startProvisioning(${portNum})" class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium text-sm">
                    Start Provisioning
                </button>
                <button onclick="closeModal()" class="flex-1 py-2 bg-[#1a1a2e] hover:bg-[#252540] rounded-lg font-medium text-sm">
                    Cancel
                </button>
            `;
            document.getElementById('port-modal').classList.remove('hidden');
        }

        function openCredentialModal(portNum) {
            selectedPort = portNum;
            const port = ports[portNum];
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;

            document.getElementById('modal-title').textContent = `Credentials Required - Port ${portNum}`;
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="p-3 bg-red-900/30 border border-red-700 rounded-lg">
                        <div class="flex items-center gap-2 text-red-300 font-medium mb-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            Authentication Failed
                        </div>
                        <div class="text-sm text-red-200">${port.last_error || 'Default credentials were rejected. Please enter the correct credentials.'}</div>
                    </div>

                    <div class="p-3 bg-[#1a1a2e] rounded-lg">
                        <div class="font-bold text-lg" style="color: ${vendor.color}">${vendor.name}</div>
                        <div class="text-sm text-gray-400">${port.device_ip || 'Unknown IP'}</div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-300 mb-2">Enter Device Credentials</div>
                        <div class="space-y-2">
                            <input type="text" id="custom-username" placeholder="Username" value="${vendor.defaultUser || 'admin'}"
                                class="w-full bg-[#1a1a2e] border border-gray-600 rounded-lg px-3 py-2 text-sm text-white">
                            <input type="password" id="custom-password" placeholder="Password"
                                class="w-full bg-[#1a1a2e] border border-gray-600 rounded-lg px-3 py-2 text-sm text-white" autofocus>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-footer').innerHTML = `
                <button onclick="retryWithCredentials(${portNum})" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium text-sm">
                    Retry with Credentials
                </button>
                <button onclick="closeModal()" class="flex-1 py-2 bg-[#1a1a2e] hover:bg-[#252540] rounded-lg font-medium text-sm">
                    Cancel
                </button>
            `;
            document.getElementById('port-modal').classList.remove('hidden');
            // Focus password field after modal opens
            setTimeout(() => document.getElementById('custom-password')?.focus(), 100);
        }

        async function retryWithCredentials(portNum) {
            const username = document.getElementById('custom-username')?.value;
            const password = document.getElementById('custom-password')?.value;

            if (!username || !password) {
                showToast('Please enter username and password', 'error');
                return;
            }

            // Clear the needs_credentials flag
            if (ports[portNum]) {
                ports[portNum].needs_credentials = false;
            }

            try {
                const response = await fetch('/api/provision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        port_number: portNum,
                        custom_username: username,
                        custom_password: password,
                    }),
                });

                const data = await response.json();
                if (response.ok) {
                    showToast('Retrying with new credentials...', 'success');
                    closeModal();
                } else {
                    showToast(data.detail || 'Failed to start', 'error');
                }
            } catch (error) {
                showToast('Failed to retry provisioning', 'error');
            }
        }

        function closeModal() {
            selectedPort = null;
            document.getElementById('port-modal').classList.add('hidden');
        }

        async function startProvisioning(portNum) {
            const username = document.getElementById('custom-username')?.value || null;
            const password = document.getElementById('custom-password')?.value || null;
            const skipFirmware = document.getElementById('skip-firmware')?.checked || false;
            const skipConfig = document.getElementById('skip-config')?.checked || false;

            try {
                const response = await fetch('/api/provision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        port_number: portNum,
                        custom_username: username,
                        custom_password: password,
                        skip_firmware: skipFirmware,
                        skip_config: skipConfig,
                    }),
                });

                const data = await response.json();
                if (response.ok) {
                    showToast('Provisioning started', 'success');
                    closeModal();
                } else {
                    showToast(data.detail || 'Failed to start', 'error');
                }
            } catch (error) {
                showToast('Failed to start provisioning', 'error');
            }
        }

        // History Modal
        function openHistoryModal() {
            document.getElementById('history-modal').classList.remove('hidden');
            fetchHistory();
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        async function fetchHistory() {
            try {
                const response = await fetch('/api/jobs?limit=50');
                const jobs = await response.json();
                renderHistory(jobs);
            } catch (error) {
                document.getElementById('history-content').innerHTML = '<div class="text-red-400 text-center py-4">Failed to load</div>';
            }
        }

        function renderHistory(jobs) {
            const container = document.getElementById('history-content');
            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8">No history</div>';
                return;
            }

            container.innerHTML = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-[#0f3460]">
                            <th class="pb-2">Time</th>
                            <th class="pb-2">Port</th>
                            <th class="pb-2">Device</th>
                            <th class="pb-2">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${jobs.map(job => {
                            const vendor = deviceVendors[job.device_type] || deviceVendors.unknown;
                            const statusColor = job.status === 'completed' ? 'text-green-400' :
                                               job.status === 'failed' ? 'text-red-400' : 'text-gray-400';
                            return `
                                <tr class="border-b border-[#0f3460]/50">
                                    <td class="py-2 text-gray-400">${formatTime(job.started_at)}</td>
                                    <td class="py-2 text-white">${job.port_number || '-'}</td>
                                    <td class="py-2"><span style="color: ${vendor.color}">${vendor.name}</span> ${job.device_model || ''}</td>
                                    <td class="py-2 ${statusColor} font-medium">${job.status?.toUpperCase()}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Settings
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            fetchSystemStatus();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        async function fetchSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                document.getElementById('system-status').innerHTML = `
                    <div class="grid grid-cols-2 gap-1 text-sm">
                        <div class="text-gray-400">Status</div>
                        <div class="${status.running ? 'text-green-400' : 'text-red-400'} font-medium">${status.running ? 'RUNNING' : 'STOPPED'}</div>
                        <div class="text-gray-400">Mode</div>
                        <div class="text-white">${status.mode?.toUpperCase() || 'VLAN'}</div>
                        <div class="text-gray-400">Active Ports</div>
                        <div class="text-white">${status.active_ports || 0} / ${status.total_ports || 6}</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('system-status').innerHTML = '<div class="text-red-400">Failed to load</div>';
            }
        }

        async function triggerGitSync() {
            try {
                const response = await fetch('/api/github/sync', { method: 'POST' });
                showToast(response.ok ? 'Sync triggered' : 'Sync failed', response.ok ? 'success' : 'error');
            } catch (error) {
                showToast('Sync failed', 'error');
            }
        }

        // Toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600',
            };
            toast.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return date.toLocaleDateString();
        }

        // Display Sleep/Wake Functions
        async function fetchDisplayConfig() {
            try {
                const response = await fetch('/api/display/status');
                const status = await response.json();
                if (status.available) {
                    displayConfig.sleep_timeout = status.sleep_timeout || 300;
                    displayConfig.wake_on_connect = status.wake_on_connect !== false;
                    displaySleeping = status.sleeping || false;
                    updateSleepOverlay();
                }
            } catch (error) {
                console.log('Display config not available:', error);
            }
        }

        function checkIdleState() {
            // Skip if sleep timeout is disabled
            if (displayConfig.sleep_timeout <= 0) {
                clearIdleTimeout();
                return;
            }

            // Count connected devices (link up or device detected)
            const hasDevices = Object.values(ports).some(p => p.link_up || p.device_detected);

            if (!hasDevices && !displaySleeping) {
                // No devices - start/reset idle timer
                startIdleTimeout();
            } else {
                // Devices connected - clear timer
                clearIdleTimeout();
                // Wake if sleeping and wake_on_connect is enabled
                if (displaySleeping && displayConfig.wake_on_connect) {
                    wakeDisplay();
                }
            }
        }

        function startIdleTimeout() {
            clearIdleTimeout();
            const timeoutMs = displayConfig.sleep_timeout * 1000;
            idleTimeout = setTimeout(sleepDisplay, timeoutMs);
        }

        function clearIdleTimeout() {
            if (idleTimeout) {
                clearTimeout(idleTimeout);
                idleTimeout = null;
            }
        }

        async function sleepDisplay() {
            if (displaySleeping) return;

            // Show overlay immediately for visual feedback
            displaySleeping = true;
            updateSleepOverlay();

            // Call backend to actually sleep the display
            try {
                await fetch('/api/display/sleep', { method: 'POST' });
            } catch (error) {
                console.log('Failed to sleep display:', error);
            }
        }

        async function wakeDisplay() {
            if (!displaySleeping) return;

            // Hide overlay immediately for visual feedback
            displaySleeping = false;
            updateSleepOverlay();

            // Call backend to wake the display
            try {
                await fetch('/api/display/wake', { method: 'POST' });
            } catch (error) {
                console.log('Failed to wake display:', error);
            }

            // Reset idle timer
            checkIdleState();
        }

        function updateSleepOverlay() {
            const overlay = document.getElementById('sleep-overlay');
            if (overlay) {
                if (displaySleeping) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function handleDisplayStateMessage(message) {
            displaySleeping = message.sleeping;
            updateSleepOverlay();
        }
    </script>
</body>
</html>
