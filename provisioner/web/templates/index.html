<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            background: #f5f5f5;
            font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', 'Menlo', monospace;
        }

        /* Fixed card sizing for 1024x600 display */
        .port-card {
            height: 250px;
            background: #ffffff;
            border: 2px solid #d1d5db;
            transition: border-color 0.2s ease;
        }

        .port-card.state-success { border-color: #16a34a; }
        .port-card.state-warning { border-color: #d97706; }
        .port-card.state-error { border-color: #dc2626; }
        .port-card.state-active { border-color: #2563eb; animation: pulse-glow 2s infinite; }
        .port-card.state-idle { border-color: #e5e7eb; }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.25); }
            50% { box-shadow: 0 0 15px 2px rgba(37, 99, 235, 0.2); }
        }

        /* Identity line at top of card */
        .card-identity {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 4px;
        }
        .vendor-tag {
            color: white; font-size: 12px; font-weight: 700;
            padding: 2px 8px; border-radius: 3px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .model-text { font-size: 15px; font-weight: 700; color: #111827; }
        .port-num-sm { font-size: 22px; font-weight: 900; color: #6b7280; margin-left: auto; }
        .speed-tag { font-size: 12px; font-weight: 700; color: #374151; }

        /* Large status center area */
        .card-status-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            margin: 4px 0;
            padding: 8px;
            gap: 4px;
        }
        .card-status-center.s-idle { background: #f3f4f6; }
        .card-status-center.s-active { background: #dbeafe; }
        .card-status-center.s-complete { background: #dcfce7; }
        .card-status-center.s-error { background: #fee2e2; }
        .card-status-center.s-booting { background: #fef3c7; }
        .card-status-center.s-ready { background: #dcfce7; }

        .status-icon-lg {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .status-icon-lg.s-active { background: #bfdbfe; color: #1e3a8a; }
        .status-icon-lg.s-complete { background: #bbf7d0; color: #14532d; }
        .status-icon-lg.s-error { background: #fecaca; color: #7f1d1d; }
        .status-icon-lg.s-booting { background: #fde68a; color: #78350f; }
        .status-icon-lg.s-ready { background: #bbf7d0; color: #14532d; }
        .status-icon-lg.s-idle { background: #e5e7eb; color: #6b7280; }

        .status-text-lg {
            font-size: 18px; font-weight: 800;
            letter-spacing: 0.5px; text-align: center;
        }
        .status-text-lg.s-active { color: #1e3a8a; }
        .status-text-lg.s-complete { color: #14532d; }
        .status-text-lg.s-error { color: #7f1d1d; }
        .status-text-lg.s-booting { color: #78350f; }
        .status-text-lg.s-ready { color: #14532d; }
        .status-text-lg.s-idle { color: #6b7280; }

        .status-sub { font-size: 14px; color: #374151; font-weight: 500; }

        @keyframes icon-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Activity log in modal */
        .log-entry { display: flex; align-items: baseline; gap: 8px; padding: 5px 0; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
        .log-time { color: #9ca3af; font-size: 11px; min-width: 60px; }
        .log-icon { width: 16px; text-align: center; flex-shrink: 0; }
        .log-step { font-weight: 500; min-width: 80px; }
        .log-detail { color: #6b7280; font-size: 12px; margin-left: auto; text-align: right; }

        /* No link state - dim the card */
        .port-card.no-link {
            opacity: 0.5;
        }

        /* Header buttons */
        .header-btn {
            min-height: 40px;
            min-width: 40px;
            background: #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover { background: #d1d5db; }

        /* Modal styles */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }

        /* Sleep overlay */
        #sleep-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: none;
            cursor: pointer;
        }
        #sleep-overlay.active {
            display: block;
        }
    </style>
</head>
<body class="text-gray-900 min-h-screen flex flex-col overflow-hidden">
    <!-- Sleep Overlay - full screen black, click/touch to wake -->
    <div id="sleep-overlay" onclick="wakeDisplay()"></div>

    <!-- Compact Header -->
    <header class="bg-white border-b border-gray-300 px-4 py-2 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-green-500" id="connection-indicator"></div>
            <h1 class="text-lg font-bold text-gray-900">Device Provisioner</h1>
            <span class="text-xs text-gray-400 font-mono" id="management-url"></span>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600 mr-2" id="status-text">Connecting...</span>
            <a href="/files" class="header-btn p-2" title="Firmware & Configs">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                </svg>
            </a>
            <button onclick="openHistoryModal()" class="header-btn p-2" title="History">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button onclick="openSettings()" class="header-btn p-2" title="Settings">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content - 2x4 Port Grid -->
    <main class="flex-1 p-3 flex items-center justify-center">
        <div class="w-full max-w-[1000px]">
            <!-- Top row: ports 2, 4, 6 (even) -->
            <div class="grid grid-cols-3 gap-3 mb-3" id="port-row-top"></div>
            <!-- Bottom row: ports 1, 3, 5 (odd) -->
            <div class="grid grid-cols-3 gap-3" id="port-row-bottom"></div>
        </div>
    </main>

    <!-- Port Action Modal -->
    <div id="port-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeModal()"></div>
        <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-md bg-white rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[80vh] border border-gray-300">
            <div class="px-5 py-3 border-b border-gray-300 flex items-center justify-between">
                <h3 class="text-lg font-bold" id="modal-title">Port Actions</h3>
                <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5" id="modal-content"></div>
            <div class="px-5 py-3 border-t border-gray-300 flex gap-2" id="modal-footer"></div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeHistoryModal()"></div>
        <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[80vh] border border-gray-300">
            <div class="px-5 py-3 border-b border-gray-300 flex items-center justify-between">
                <h3 class="text-lg font-bold">Provisioning History</h3>
                <button onclick="closeHistoryModal()" class="p-2 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5" id="history-content">
                <div class="text-gray-600 text-center py-8">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeSettings()"></div>
        <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-md bg-white rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[80vh] border border-gray-300">
            <div class="px-5 py-3 border-b border-gray-300 flex items-center justify-between">
                <h3 class="text-lg font-bold">Settings</h3>
                <button onclick="closeSettings()" class="p-2 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">System Status</label>
                    <div class="bg-gray-50 rounded-lg p-3 text-sm border border-gray-200" id="system-status">Loading...</div>
                </div>
                <div class="space-y-2">
                    <button onclick="triggerGitSync()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium text-sm text-white">
                        Sync GitHub Repository
                    </button>
                    <button onclick="location.reload()" class="w-full py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm text-gray-800">
                        Refresh Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // State
        let ws = null;
        let ports = {};
        let selectedPort = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        let portActivityLogs = {};

        // Display sleep state
        let displaySleeping = false;
        let idleTimeout = null;
        let displayConfig = {
            sleep_timeout: 300,
            wake_on_connect: true,
        };

        // Device vendors
        const deviceVendors = {
            cambium: { name: 'Cambium', color: '#22c55e', defaultUser: 'admin' },
            mikrotik: { name: 'MikroTik', color: '#3b82f6', defaultUser: 'admin' },
            tachyon: { name: 'Tachyon', color: '#a855f7', defaultUser: 'root' },
            tarana: { name: 'Tarana', color: '#d97706', defaultUser: 'admin' },
            unknown: { name: 'Unknown', color: '#6b7280', defaultUser: 'admin' },
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Display management URL in header
            document.getElementById('management-url').textContent = window.location.host;
            // Fetch display config (for sleep timeout)
            fetchDisplayConfig();
            connectWebSocket();
        });

        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/status`);

            ws.onopen = () => {
                document.getElementById('connection-indicator').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('status-text').textContent = 'Connected';
                reconnectAttempts = 0;
            };

            ws.onclose = () => {
                document.getElementById('connection-indicator').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('status-text').textContent = 'Disconnected';
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                }
            };

            ws.onerror = (error) => console.error('WebSocket error:', error);

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'initial_status':
                case 'status_update':
                    updatePorts(message.data.ports);
                    checkIdleState();
                    break;
                case 'display_state':
                    handleDisplayStateMessage(message);
                    break;
                case 'port_update':
                    // Track activity log from checklist diffs
                    if (message.data?.checklist && ports[message.port_number]) {
                        const oldCl = ports[message.port_number].checklist || {};
                        const newCl = message.data.checklist;
                        const pn = message.port_number;
                        if (!portActivityLogs[pn]) portActivityLogs[pn] = [];
                        const now = new Date().toLocaleTimeString('en-US', { hour12: false });
                        const stepNames = { login: 'Login', model_confirmed: 'Model', firmware_banks: 'FW Check',
                            firmware_update_1: 'FW Bank 1', firmware_update_2: 'FW Bank 2',
                            config_upload: 'Config', config_verify: 'Verify',
                            reboot: 'Reboot', verify: 'Verify FW' };
                        // Parse FW versions for detail on fw update steps
                        let fwVersions = {};
                        const fwSrc = newCl.firmware_banks || oldCl.firmware_banks;
                        if (fwSrc) {
                            fwSrc.split('|').forEach(p => { const [k2,v] = p.split(':'); if(k2&&v) fwVersions[k2]=v; });
                        }
                        for (const key of Object.keys(stepNames)) {
                            if (newCl[key] !== undefined && newCl[key] !== oldCl[key]) {
                                const state = getIconState(newCl, key);
                                let detail = '';
                                if (key === 'model_confirmed' && typeof newCl[key] === 'string') detail = newCl[key];
                                if (key === 'firmware_banks' && typeof newCl[key] === 'string') {
                                    const fp = {};
                                    newCl[key].split('|').forEach(p => { const [k2,v] = p.split(':'); if(k2&&v) fp[k2]=v; });
                                    const v1 = (fp.bank1 || '?').split(' ')[0];
                                    const v2 = (fp.bank2 || '?').split(' ')[0];
                                    detail = v1 === v2 ? v1 : `${v1} / ${v2}`;
                                    if (fp.active) detail += ` (bank ${fp.active})`;
                                }
                                if (key === 'firmware_update_1') detail = fwVersions.bank1 || detail;
                                if (key === 'firmware_update_2') detail = fwVersions.bank2 || detail;
                                if (key === 'login' && typeof newCl.mac_address === 'string') detail = newCl.mac_address;
                                portActivityLogs[pn].push({ time: now, step: stepNames[key], state, detail });
                            }
                        }
                    }
                    updateSinglePort(message.port_number, message.data);
                    checkIdleState();
                    break;
                case 'provisioning_started':
                case 'provisioning_progress':
                case 'provisioning_completed':
                case 'credentials_required':
                    // Update port data and re-render
                    if (ports[message.port_number]) {
                        if (message.type === 'provisioning_started') {
                            ports[message.port_number].provisioning = true;
                            ports[message.port_number].current_step = 'starting';
                            const now = new Date().toLocaleTimeString('en-US', { hour12: false });
                            // Wipe log for fresh run. renderActivityLog reconstructs any
                            // fast-completing steps from the checklist state.
                            portActivityLogs[message.port_number] = [{ time: now, step: 'Started', state: 'loading', detail: '' }];
                        } else if (message.type === 'provisioning_progress') {
                            // Track current step for status display
                            ports[message.port_number].current_step = message.step;
                        } else if (message.type === 'provisioning_completed') {
                            ports[message.port_number].provisioning = false;
                            ports[message.port_number].current_step = null;
                            ports[message.port_number].last_result = message.success ? 'complete' : 'failed';
                            ports[message.port_number].last_error = message.data?.error;
                            const pn = message.port_number;
                            if (!portActivityLogs[pn]) portActivityLogs[pn] = [];
                            portActivityLogs[pn].push({ time: new Date().toLocaleTimeString('en-US', { hour12: false }), step: message.success ? 'Complete' : 'Failed', state: message.success ? 'success' : 'error', detail: message.data?.error || '' });
                            // Preserve needs_credentials flag from completion data
                            if (message.data?.needs_credentials) {
                                ports[message.port_number].needs_credentials = true;
                            }
                            showToast(
                                message.success ? `Port ${message.port_number}: Complete` : `Port ${message.port_number}: Failed`,
                                message.success ? 'success' : 'error'
                            );
                        } else if (message.type === 'credentials_required') {
                            ports[message.port_number].needs_credentials = true;
                            ports[message.port_number].last_error = message.error || 'Invalid credentials';
                            showToast(`Port ${message.port_number}: Tap to enter credentials`, 'warning');
                            // Don't auto-open modal - let user tap the port card
                        }
                        renderPorts();
                    }
                    break;
            }
        }

        function updatePorts(portsData) {
            ports = portsData;
            renderPorts();
        }

        function updateSinglePort(portNumber, data) {
            ports[portNumber] = { ...ports[portNumber], ...data };
            renderPorts();
        }

        function formatSpeed(speed) {
            if (!speed) return null;
            return speed.replace('bps', '').replace('Gbps', 'G').replace('Mbps', 'M');
        }

        function getCardState(port) {
            const checklist = port.checklist || {};

            if (!port.link_up) return 'idle';
            if (port.provisioning) return 'active';
            // Loading firmware updates
            if (checklist.firmware_update_1 === 'loading' || checklist.firmware_update_2 === 'loading') return 'active';
            // Complete when verify is done
            if (port.last_result === 'complete' || port.last_result === 'success' || (checklist.login === true && (checklist.verify === true || checklist.config_verify === true))) return 'success';
            // Failed
            if (port.last_result === 'failed' || checklist.login === false || checklist.firmware_update_1 === false) return 'error';
            if (port.waiting_for_boot) return 'warning';
            if (port.device_detected) return 'success';
            return 'warning';
        }

        function getIconState(checklist, key) {
            const value = checklist[key];
            if (value === true) return 'success';
            if (value === false) return 'error';
            if (value === 'loading') return 'loading';
            if (value === 'skipped') return 'skipped';
            if (typeof value === 'string' && value.length > 0) return 'success'; // e.g., model_confirmed with name
            return 'pending';
        }

        function renderPorts() {
            const topRow = document.getElementById('port-row-top');
            const bottomRow = document.getElementById('port-row-bottom');
            topRow.innerHTML = '';
            bottomRow.innerHTML = '';

            const topPorts = [2, 4, 6];
            const bottomPorts = [1, 3, 5];

            for (const portNum of topPorts) {
                const port = ports[portNum] || { vlan_id: 1990 + portNum, link_up: false };
                topRow.appendChild(createPortCard(portNum, port));
            }

            for (const portNum of bottomPorts) {
                const port = ports[portNum] || { vlan_id: 1990 + portNum, link_up: false };
                bottomRow.appendChild(createPortCard(portNum, port));
            }

            // Live-update modal if it's open for this port
            if (selectedPort && !document.getElementById('port-modal').classList.contains('hidden')) {
                const port = ports[selectedPort];
                if (port) {
                    const logContainer = document.getElementById('modal-content');
                    // Only refresh if it's the activity log modal (not provision/credential modal)
                    if (logContainer && !logContainer.querySelector('[id^="skip-"]') && !logContainer.querySelector('#custom-username')) {
                        openPortModal(selectedPort);
                    }
                }
            }
        }

        function getStepProgress(port) {
            const cl = port.checklist || {};
            // Only count steps that are present in the checklist (not all possible steps)
            const allKeys = ['login', 'model_confirmed', 'firmware_banks', 'firmware_update_1', 'config_upload', 'config_verify', 'firmware_update_2', 'reboot', 'verify'];
            let done = 0, total = 0;
            for (const k of allKeys) {
                if (cl[k] === undefined) continue;
                total++;
                const v = cl[k];
                if (v === true || v === 'skipped' || (typeof v === 'string' && v.length > 0 && v !== 'loading')) done++;
            }
            if (total === 0) total = 1; // avoid division by zero
            return { done, total };
        }

        function getStatusCenterInfo(port) {
            const checklist = port.checklist || {};
            if (!port.link_up) return { text: 'NO LINK', cls: 'idle', icon: 'dash' };
            if (port.needs_credentials) return { text: 'NEEDS CREDENTIALS', sub: 'Tap to enter password', cls: 'error', icon: 'alert' };
            if (port.provisioning) {
                const stepLabels = {
                    'starting': 'STARTING', 'detecting': 'DETECTING', 'configuring': 'CONFIGURING',
                    'login': 'LOGGING IN', 'model_confirmed': 'DETECTING MODEL',
                    'device_info': 'READING INFO', 'firmware_banks': 'CHECKING FIRMWARE',
                    'firmware_update_1': 'UPDATING FW 1', 'firmware_update_2': 'UPDATING FW 2',
                    'config_upload': 'APPLYING CONFIG', 'config_verify': 'VERIFYING CONFIG',
                    'reboot': 'REBOOTING', 'verify': 'VERIFYING FW',
                };
                // Use current step label, or derive from last completed checklist step
                let text = stepLabels[port.current_step];
                if (!text) {
                    const cl = port.checklist || {};
                    const stepOrder = ['login', 'model_confirmed', 'firmware_banks', 'firmware_update_1', 'config_upload', 'config_verify', 'firmware_update_2', 'reboot', 'verify'];
                    for (const k of stepOrder) {
                        if (cl[k] === 'loading') { text = stepLabels[k]; break; }
                    }
                    if (!text) text = 'STARTING';
                }
                const prog = getStepProgress(port);
                const stepNum = Math.min(prog.done + 1, prog.total);
                return { text, sub: `Step ${stepNum} of ${prog.total}`, cls: 'active', icon: 'spinner' };
            }
            if (port.waiting_for_boot) return { text: 'BOOTING', sub: 'Waiting for device...', cls: 'booting', icon: 'spinner' };
            if (checklist.firmware_update_1 === 'loading' || checklist.firmware_update_2 === 'loading') {
                const prog = getStepProgress(port);
                const stepNum = Math.min(prog.done + 1, prog.total);
                return { text: 'UPDATING FIRMWARE', sub: `Step ${stepNum} of ${prog.total}`, cls: 'active', icon: 'spinner' };
            }
            if (checklist.reboot === true && checklist.verify !== true) {
                return { text: 'REBOOTING', sub: 'Waiting for device...', cls: 'booting', icon: 'spinner' };
            }
            const isDone = port.last_result === 'complete' || port.last_result === 'success';
            if (isDone) {
                return { text: 'COMPLETE', sub: 'Ready to deploy', cls: 'complete', icon: 'check' };
            }
            const loginOk = checklist.login === true;
            const configOk = checklist.config_upload === true || checklist.config_upload === 'skipped';
            const verifyOk = checklist.verify === true || checklist.config_verify === true;
            if (loginOk && configOk && verifyOk) {
                return { text: 'COMPLETE', sub: 'Ready to deploy', cls: 'complete', icon: 'check' };
            }
            if (checklist.login === false || checklist.firmware_update_1 === false || port.last_result === 'failed') {
                return { text: 'FAILED', sub: port.last_error ? port.last_error.substring(0, 40) : 'Tap for details', cls: 'error', icon: 'x' };
            }
            if (port.device_detected) return { text: 'READY', sub: 'Tap to provision', cls: 'ready', icon: 'check' };
            return { text: 'DETECTING', sub: 'Waiting for device...', cls: 'booting', icon: 'spinner' };
        }

        function statusIconSVG(type, cls) {
            const svgs = {
                spinner: `<svg width="20" height="20" viewBox="0 0 20 20" style="animation:spin 1s linear infinite"><path d="M10 2a8 8 0 016.93 4" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>`,
                check: `<svg width="20" height="20" viewBox="0 0 20 20"><path d="M4 10l4 4 8-8" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                x: `<svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 5l10 10M15 5l-10 10" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>`,
                alert: `<svg width="20" height="20" viewBox="0 0 20 20"><path d="M10 6v5m0 3h.01" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>`,
                dash: `<svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 10h10" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>`,
            };
            return `<div class="status-icon-lg s-${cls}">${svgs[type] || svgs.dash}</div>`;
        }

        function createPortCard(portNum, port) {
            const div = document.createElement('div');
            const checklist = port.checklist || {};
            const cardState = getCardState(port);
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;
            const speed = formatSpeed(port.link_speed);
            const model = checklist.model_confirmed || port.device_model;
            const noLink = !port.link_up;
            const hasDevice = port.device_detected || checklist.login;
            const sc = getStatusCenterInfo(port);

            div.className = `port-card rounded-xl p-3 flex flex-col state-${cardState} ${noLink ? 'no-link' : ''}`;
            const clickable = port.device_detected || port.needs_credentials;
            div.onclick = () => {
                if (port.needs_credentials) {
                    openCredentialModal(portNum);
                } else if (port.device_detected) {
                    openPortModal(portNum);
                }
            };
            div.style.cursor = clickable ? 'pointer' : 'default';

            div.innerHTML = `
                <!-- Identity line -->
                <div class="card-identity">
                    ${hasDevice ? `
                        <span class="vendor-tag" style="background:${vendor.color}">${vendor.name}</span>
                        <span class="model-text">${model || ''}</span>
                    ` : ''}
                    <span class="port-num-sm">${portNum}</span>
                    ${speed ? `<span class="speed-tag">${speed}</span>` : ''}
                </div>

                <!-- Big status center -->
                <div class="card-status-center s-${sc.cls}">
                    ${statusIconSVG(sc.icon, sc.cls)}
                    <div class="status-text-lg s-${sc.cls}">${sc.text}</div>
                    ${sc.sub ? `<div class="status-sub">${sc.sub}</div>` : ''}
                </div>
            `;

            return div;
        }

        // Modal functions
        function openPortModal(portNum) {
            selectedPort = portNum;
            const port = ports[portNum];
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;
            const checklist = port.checklist || {};
            const mac = checklist.mac_address || port.device_mac;
            const serial = checklist.serial_number || port.device_serial;
            const model = checklist.model_confirmed || port.device_model;

            // Parse firmware versions
            let fw1Ver = '', fw2Ver = '', activeBank = '';
            if (checklist.firmware_banks) {
                const parts = {};
                checklist.firmware_banks.split('|').forEach(p => {
                    const [k, v] = p.split(':');
                    if (k && v) parts[k] = v;
                });
                fw1Ver = parts.bank1 || '';
                fw2Ver = parts.bank2 || '';
                activeBank = parts.active || '';
            }

            document.getElementById('modal-title').textContent = `Port ${portNum} \u2014 ${vendor.name} ${model || ''}`;

            // Build device info rows
            const infoRows = [];
            if (mac) infoRows.push(['MAC', mac, 'text-blue-700']);
            if (serial) infoRows.push(['Serial', serial, 'text-purple-700']);
            if (port.device_ip) infoRows.push(['IP', port.device_ip, 'text-gray-900']);
            if (port.link_speed) infoRows.push(['Link', port.link_speed, 'text-gray-900']);
            if (fw1Ver) infoRows.push(['FW Bank 1', fw1Ver + (activeBank === '1' ? ' (active)' : ''), 'text-green-700']);
            if (fw2Ver) infoRows.push(['FW Bank 2', fw2Ver + (activeBank === '2' ? ' (active)' : ''), 'text-green-700']);

            document.getElementById('modal-content').innerHTML = `
                <!-- Device summary grid -->
                ${infoRows.length > 0 ? `
                <div style="display:grid; grid-template-columns: auto 1fr; gap: 2px 12px; font-size: 12px; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #e5e7eb;">
                    ${infoRows.map(([label, value, cls]) => `
                        <span style="color:#9ca3af">${label}</span>
                        <span class="${cls}" style="font-family:monospace">${value}</span>
                    `).join('')}
                </div>` : ''}

                <!-- Activity log -->
                ${renderActivityLog(portNum)}

                ${port.last_error ? `
                    <div class="mt-4 p-3 bg-red-50 border border-red-300 rounded-lg text-red-700 text-sm">
                        ${port.last_error}
                    </div>
                ` : ''}
            `;
            const isActive = port.provisioning || port.waiting_for_boot;
            document.getElementById('modal-footer').innerHTML = isActive ? `
                <button onclick="closeModal()" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm text-gray-800">
                    Close
                </button>
            ` : `
                <button onclick="openProvisionModal(${portNum})" class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium text-sm text-white">
                    Retry
                </button>
                <button onclick="closeModal()" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm text-gray-800">
                    Close
                </button>
            `;
            document.getElementById('port-modal').classList.remove('hidden');
        }

        function renderActivityLog(portNum) {
            const log = portActivityLogs[portNum];
            const port = ports[portNum];
            const stateIcons = { success: '\u2713', error: '\u2717', loading: '\u25cf', pending: '\u25cb', skipped: '\u2014' };
            const stateColors = { success: '#166534', error: '#991b1b', loading: '#1e40af', pending: '#9ca3af', skipped: '#9ca3af' };

            function renderEntry(entry) {
                const icon = stateIcons[entry.state] || '\u25cb';
                const color = stateColors[entry.state] || '#6b7280';
                const loadingAnim = entry.state === 'loading' ? 'animation:icon-pulse 1.5s infinite;' : '';
                return `<div class="log-entry" ${entry.state === 'loading' ? 'style="background:#eff6ff;border-radius:4px;margin:0 -4px;padding:5px 4px;"' : ''}>
                    <span class="log-time">${entry.time || ''}</span>
                    <span class="log-icon" style="color:${color};${loadingAnim}">${icon}</span>
                    <span class="log-step" style="color:${color};${entry.state === 'loading' ? 'font-weight:600;' : ''}">${entry.step}</span>
                    ${entry.detail ? `<span class="log-detail">${entry.detail}</span>` : ''}
                </div>`;
            }

            // Build unified list in canonical provisioning order
            // Steps that never appear in checklist or log are omitted (e.g. reboot when no FW update)
            const allSteps = [
                ['login', 'Login'], ['model_confirmed', 'Model'], ['firmware_banks', 'FW Check'],
                ['firmware_update_1', 'FW Bank 1'], ['config_upload', 'Config'], ['config_verify', 'Verify'],
                ['firmware_update_2', 'FW Bank 2'], ['reboot', 'Reboot'], ['verify', 'Verify FW']
            ];
            const checklist = port?.checklist || {};
            const isActive = port && (port.provisioning || port.waiting_for_boot);
            const curStep = port?.current_step;

            // Index logged entries by step label (use last entry for each label)
            const logByLabel = {};
            if (log) { for (const entry of log) { logByLabel[entry.step] = entry; } }

            // Parse FW versions for detail
            let fwV = {};
            if (checklist.firmware_banks) { checklist.firmware_banks.split('|').forEach(p => { const [a,b] = p.split(':'); if(a&&b) fwV[a]=b; }); }

            let html = '';
            // Render "Started" entry — show as success once any real step has completed
            if (logByLabel['Started']) {
                const startEntry = { ...logByLabel['Started'] };
                const hasAnyStep = Object.keys(logByLabel).some(k => k !== 'Started' && k !== 'Complete' && k !== 'Failed')
                    || allSteps.some(([k]) => { const s = getIconState(checklist, k); return s === 'success' || s === 'error' || s === 'skipped'; });
                if (hasAnyStep) startEntry.state = 'success';
                html += renderEntry(startEntry);
            }

            // Find the LAST loading step — that's the true current step.
            // Earlier 'loading' entries are stale (backend doesn't always clear them).
            let lastLoadingKey = null;
            if (isActive) {
                for (const [key] of allSteps) {
                    if (getIconState(checklist, key) === 'loading') lastLoadingKey = key;
                }
            }

            for (const [key, label] of allSteps) {
                // Skip steps that never appeared in checklist or log — they weren't part of this run
                const logged = logByLabel[label];
                if (checklist[key] === undefined && !logged) continue;

                // Determine state from checklist
                let state = getIconState(checklist, key);

                // Only the LAST loading step should actually show as loading.
                // Earlier 'loading' steps have implicitly succeeded (we moved past them).
                if (isActive && state === 'loading' && key !== lastLoadingKey) {
                    state = 'success';
                }
                // current_step override
                if (isActive && state === 'pending' && curStep === key) state = 'loading';

                // Build detail text
                let detail = '';
                if (key === 'model_confirmed' && typeof checklist[key] === 'string') detail = checklist[key];
                if (key === 'firmware_update_1') detail = fwV.bank1 || '';
                if (key === 'firmware_update_2') detail = fwV.bank2 || '';
                if (key === 'firmware_banks') {
                    const v1 = (fwV.bank1 || '?').split(' ')[0];
                    const v2 = (fwV.bank2 || '?').split(' ')[0];
                    detail = v1 === v2 ? v1 : `${v1} / ${v2}`;
                    if (fwV.active) detail += ` (bank ${fwV.active})`;
                }

                // Use logged entry timestamp if available
                const time = logged ? logged.time : '';
                if (logged) detail = logged.detail || detail;

                // If active and this is the first pending step after all done ones, show as loading
                if (isActive && state === 'pending' && !lastLoadingKey) {
                    // No loading step in checklist — promote first pending
                    state = 'loading';
                    lastLoadingKey = key; // prevent promoting more than one
                }

                // Only show completed/error/skipped always, loading/pending only during active
                if (state === 'success' || state === 'skipped' || state === 'error') {
                    html += renderEntry({ time, step: label, state, detail });
                } else if (isActive && state === 'loading') {
                    html += renderEntry({ time: '', step: label, state: 'loading', detail: '' });
                } else if (isActive && state === 'pending') {
                    html += renderEntry({ time: '', step: label, state: 'pending', detail: '' });
                }
            }

            // Render "Complete" / "Failed" entry if present
            if (logByLabel['Complete']) html += renderEntry(logByLabel['Complete']);
            if (logByLabel['Failed']) html += renderEntry(logByLabel['Failed']);

            if (!html) {
                return '<div class="text-gray-400 text-center py-6 text-sm">No activity recorded yet.<br>Provisioning steps will appear here.</div>';
            }
            return html;
        }

        function openProvisionModal(portNum) {
            selectedPort = portNum;
            const port = ports[portNum];
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;

            document.getElementById('modal-title').textContent = `Provision Port ${portNum}`;
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="font-bold text-lg" style="color: ${vendor.color}">${vendor.name}</div>
                        <div class="text-sm text-gray-600">${port.device_ip || 'Unknown IP'}</div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-600 mb-2">Options</div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="skip-config" class="w-5 h-5 rounded bg-white border-gray-300">
                                <span class="text-sm text-gray-900">Skip configuration</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="skip-firmware" class="w-5 h-5 rounded bg-white border-gray-300">
                                <span class="text-sm text-gray-900">Skip firmware update</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-600 mb-2">Custom Credentials (optional)</div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="custom-username" placeholder="Username"
                                class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900">
                            <input type="password" id="custom-password" placeholder="Password"
                                class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-footer').innerHTML = `
                <button onclick="startProvisioning(${portNum})" class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium text-sm text-white">
                    Start Provisioning
                </button>
                <button onclick="closeModal()" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm text-gray-800">
                    Cancel
                </button>
            `;
            document.getElementById('port-modal').classList.remove('hidden');
        }

        function openCredentialModal(portNum) {
            selectedPort = portNum;
            const port = ports[portNum];
            const vendor = deviceVendors[port.device_type] || deviceVendors.unknown;

            document.getElementById('modal-title').textContent = `Credentials Required - Port ${portNum}`;
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="p-3 bg-red-50 border border-red-300 rounded-lg">
                        <div class="flex items-center gap-2 text-red-700 font-medium mb-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            Authentication Failed
                        </div>
                        <div class="text-sm text-red-700">${port.last_error || 'Default credentials were rejected. Please enter the correct credentials.'}</div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="font-bold text-lg" style="color: ${vendor.color}">${vendor.name}</div>
                        <div class="text-sm text-gray-600">${port.device_ip || 'Unknown IP'}</div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-600 mb-2">Enter Device Credentials</div>
                        <div class="space-y-2">
                            <input type="text" id="custom-username" placeholder="Username" value="${vendor.defaultUser || 'admin'}"
                                class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900">
                            <input type="password" id="custom-password" placeholder="Password"
                                class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900" autofocus>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-footer').innerHTML = `
                <button onclick="retryWithCredentials(${portNum})" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium text-sm text-white">
                    Retry with Credentials
                </button>
                <button onclick="closeModal()" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm text-gray-800">
                    Cancel
                </button>
            `;
            document.getElementById('port-modal').classList.remove('hidden');
            // Focus password field after modal opens
            setTimeout(() => document.getElementById('custom-password')?.focus(), 100);
        }

        async function retryWithCredentials(portNum) {
            const username = document.getElementById('custom-username')?.value;
            const password = document.getElementById('custom-password')?.value;

            if (!username || !password) {
                showToast('Please enter username and password', 'error');
                return;
            }

            // Clear the needs_credentials flag
            if (ports[portNum]) {
                ports[portNum].needs_credentials = false;
            }

            try {
                const response = await fetch('/api/provision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        port_number: portNum,
                        custom_username: username,
                        custom_password: password,
                    }),
                });

                const data = await response.json();
                if (response.ok) {
                    showToast('Retrying with new credentials...', 'success');
                    closeModal();
                } else {
                    showToast(data.detail || 'Failed to start', 'error');
                }
            } catch (error) {
                showToast('Failed to retry provisioning', 'error');
            }
        }

        function closeModal() {
            selectedPort = null;
            document.getElementById('port-modal').classList.add('hidden');
        }

        async function startProvisioning(portNum) {
            const username = document.getElementById('custom-username')?.value || null;
            const password = document.getElementById('custom-password')?.value || null;
            const skipFirmware = document.getElementById('skip-firmware')?.checked || false;
            const skipConfig = document.getElementById('skip-config')?.checked || false;

            try {
                const response = await fetch('/api/provision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        port_number: portNum,
                        custom_username: username,
                        custom_password: password,
                        skip_firmware: skipFirmware,
                        skip_config: skipConfig,
                    }),
                });

                const data = await response.json();
                if (response.ok) {
                    showToast('Provisioning started', 'success');
                    closeModal();
                } else {
                    showToast(data.detail || 'Failed to start', 'error');
                }
            } catch (error) {
                showToast('Failed to start provisioning', 'error');
            }
        }

        // History Modal
        function openHistoryModal() {
            document.getElementById('history-modal').classList.remove('hidden');
            fetchHistory();
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        async function fetchHistory() {
            try {
                const response = await fetch('/api/jobs?limit=50');
                const jobs = await response.json();
                renderHistory(jobs);
            } catch (error) {
                document.getElementById('history-content').innerHTML = '<div class="text-red-700 text-center py-4">Failed to load</div>';
            }
        }

        function renderHistory(jobs) {
            const container = document.getElementById('history-content');
            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-gray-600 text-center py-8">No history</div>';
                return;
            }

            container.innerHTML = jobs.map((job, i) => {
                const vendor = deviceVendors[job.device_type] || deviceVendors.unknown;
                const isOk = job.status === 'completed';
                const isFail = job.status === 'failed';
                const statusColor = isOk ? '#166534' : isFail ? '#991b1b' : '#6b7280';
                const statusIcon = isOk ? '\u2713' : isFail ? '\u2717' : '\u25cf';
                const statusText = job.status?.toUpperCase();
                const ident = job.mac_address || job.serial_number || '';
                const identLabel = job.mac_address && job.serial_number
                    ? `${job.mac_address} / ${job.serial_number}`
                    : ident;

                // Build detail rows for expand
                const details = [];
                if (job.mac_address) details.push(['MAC', job.mac_address]);
                if (job.serial_number) details.push(['Serial', job.serial_number]);
                if (job.ip_address) details.push(['IP', job.ip_address]);
                if (job.device_model) details.push(['Model', job.device_model]);
                if (job.old_firmware) details.push(['FW Before', job.old_firmware]);
                if (job.new_firmware) details.push(['FW After', job.new_firmware]);
                if (job.config_applied) details.push(['Config', job.config_applied]);
                if (job.started_at) details.push(['Started', new Date(job.started_at).toLocaleString('en-US', { hour12: false })]);
                if (job.completed_at) details.push(['Completed', new Date(job.completed_at).toLocaleString('en-US', { hour12: false })]);
                if (job.error_message) details.push(['Error', job.error_message]);

                return `
                    <div class="border-b border-gray-200">
                        <div class="flex items-center gap-3 py-3 cursor-pointer hover:bg-gray-50 px-1 rounded" onclick="toggleHistoryDetail(${i})">
                            <span style="color:${statusColor};font-size:14px;width:16px;text-align:center">${statusIcon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="font-medium" style="color:${vendor.color}">${vendor.name}</span>
                                    <span class="text-gray-900">${job.device_model || ''}</span>
                                    <span class="text-gray-400">Port ${job.port_number || '?'}</span>
                                </div>
                                <div class="text-xs text-gray-500 truncate font-mono">${identLabel}</div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-xs font-medium" style="color:${statusColor}">${statusText}</div>
                                <div class="text-xs text-gray-400">${formatTime(job.started_at)}</div>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 transition-transform" id="history-chevron-${i}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div id="history-detail-${i}" class="hidden pb-3 px-1">
                            <div style="display:grid; grid-template-columns: auto 1fr; gap: 2px 12px; font-size: 12px; padding: 8px 12px; background: #f9fafb; border-radius: 6px; margin-left: 28px;">
                                ${details.map(([label, value]) => `
                                    <span style="color:#9ca3af">${label}</span>
                                    <span class="${label === 'Error' ? 'text-red-700' : 'text-gray-900'}" style="font-family:monospace;word-break:break-all">${value}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleHistoryDetail(index) {
            const detail = document.getElementById(`history-detail-${index}`);
            const chevron = document.getElementById(`history-chevron-${index}`);
            if (detail) {
                detail.classList.toggle('hidden');
                chevron?.classList.toggle('rotate-180');
            }
        }

        // Settings
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            fetchSystemStatus();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        async function fetchSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                document.getElementById('system-status').innerHTML = `
                    <div class="grid grid-cols-2 gap-1 text-sm">
                        <div class="text-gray-600">Status</div>
                        <div class="${status.running ? 'text-green-700' : 'text-red-700'} font-medium">${status.running ? 'RUNNING' : 'STOPPED'}</div>
                        <div class="text-gray-600">Mode</div>
                        <div class="text-gray-900">${status.mode?.toUpperCase() || 'VLAN'}</div>
                        <div class="text-gray-600">Active Ports</div>
                        <div class="text-gray-900">${status.active_ports || 0} / ${status.total_ports || 6}</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('system-status').innerHTML = '<div class="text-red-700">Failed to load</div>';
            }
        }

        async function triggerGitSync() {
            try {
                const response = await fetch('/api/github/sync', { method: 'POST' });
                showToast(response.ok ? 'Sync triggered' : 'Sync failed', response.ok ? 'success' : 'error');
            } catch (error) {
                showToast('Sync failed', 'error');
            }
        }

        // Toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600',
            };
            toast.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const timeStr = date.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            // Today: show time + relative
            if (diffMins < 1) return `${timeStr} (now)`;
            if (diffMins < 60) return `${timeStr} (${diffMins}m ago)`;
            if (diffMins < 1440) return `${timeStr} (${Math.floor(diffMins / 60)}h ago)`;
            // Older: show date + time
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + timeStr;
        }

        // Display Sleep/Wake Functions
        async function fetchDisplayConfig() {
            try {
                const response = await fetch('/api/display/status');
                const status = await response.json();
                if (status.available) {
                    displayConfig.sleep_timeout = status.sleep_timeout || 300;
                    displayConfig.wake_on_connect = status.wake_on_connect !== false;
                    displaySleeping = status.sleeping || false;
                    updateSleepOverlay();
                }
            } catch (error) {
                console.log('Display config not available:', error);
            }
        }

        function checkIdleState() {
            // Skip if sleep timeout is disabled
            if (displayConfig.sleep_timeout <= 0) {
                clearIdleTimeout();
                return;
            }

            // Count connected devices (link up or device detected)
            const hasDevices = Object.values(ports).some(p => p.link_up || p.device_detected);

            if (!hasDevices && !displaySleeping) {
                // No devices - start/reset idle timer
                startIdleTimeout();
            } else {
                // Devices connected - clear timer
                clearIdleTimeout();
                // Wake if sleeping and wake_on_connect is enabled
                if (displaySleeping && displayConfig.wake_on_connect) {
                    wakeDisplay();
                }
            }
        }

        function startIdleTimeout() {
            clearIdleTimeout();
            const timeoutMs = displayConfig.sleep_timeout * 1000;
            idleTimeout = setTimeout(sleepDisplay, timeoutMs);
        }

        function clearIdleTimeout() {
            if (idleTimeout) {
                clearTimeout(idleTimeout);
                idleTimeout = null;
            }
        }

        async function sleepDisplay() {
            if (displaySleeping) return;

            // Show overlay immediately for visual feedback
            displaySleeping = true;
            updateSleepOverlay();

            // Call backend to actually sleep the display
            try {
                await fetch('/api/display/sleep', { method: 'POST' });
            } catch (error) {
                console.log('Failed to sleep display:', error);
            }
        }

        async function wakeDisplay() {
            if (!displaySleeping) return;

            // Hide overlay immediately for visual feedback
            displaySleeping = false;
            updateSleepOverlay();

            // Call backend to wake the display
            try {
                await fetch('/api/display/wake', { method: 'POST' });
            } catch (error) {
                console.log('Failed to wake display:', error);
            }

            // Reset idle timer
            checkIdleState();
        }

        function updateSleepOverlay() {
            const overlay = document.getElementById('sleep-overlay');
            if (overlay) {
                if (displaySleeping) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function handleDisplayStateMessage(message) {
            displaySleeping = message.sleeping;
            updateSleepOverlay();
        }
    </script>
</body>
</html>
